# SSL configuration (single instance to avoid duplicates)
ssl_certificate /etc/ssl/certs/serp24.online_fullchain.crt;
ssl_certificate_key /etc/ssl/private/_.serp24.online_private_key.key;
ssl_protocols TLSv1.2 TLSv1.3;
ssl_prefer_server_ciphers on;
ssl_ciphers EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH;

# HSTS to enforce HTTPS
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

# Security headers
add_header X-Content-Type-Options "nosniff" always;
add_header X-Frame-Options "DENY" always;
add_header Content-Security-Policy "default-src 'self'; script-src 'self' https://www.googletagmanager.com; style-src 'self' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; object-src 'none'; img-src 'self' data:;" always;

# Enable ETag and conditional requests
etag on;
if_modified_since exact;

# Gzip compression
gzip on;
gzip_comp_level 6; # Balanced compression level
gzip_min_length 256;
gzip_proxied any; # Compress proxied responses
gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
gzip_vary on;

# Serve Next.js static files directly
location /_next/static/ {
    alias /var/www/html/_next/static/;
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";
    access_log off; # Reduce logging for static files
    try_files $uri $uri/ =404;
}

# Serve other static assets (e.g., images, favicon)
location ~* \.(jpg|jpeg|png|gif|ico|webp|woff|woff2|svg|json)$ {
    root /var/www/html;
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";
    access_log off;
    try_files $uri $uri/ @next;
}

# Cache SSG pages with proxy caching
location ~* ^(/|/contact|/website-scan)$ {
    proxy_cache my_cache;
    proxy_cache_valid 200 1h; # Cache for 1 hour
    proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    add_header Cache-Control "public, max-age=3600, stale-while-revalidate=7200";
    add_header X-Cache-Status $upstream_cache_status; # Debug cache hits/misses
    proxy_pass http://127.0.0.1:3003;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 90;
}

# Proxy all other requests to Next.js app (no caching for dynamic content)
location / {
    proxy_pass http://127.0.0.1:3003;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 90;
}

# Proxy redirect for all locations
proxy_redirect http://127.0.0.1:3003 https://fadilogic.serp24.online;

# Error handling
error_page 404 /404.html;
error_page 500 502 503 504 /50x.html;
location = /404.html {
    root /var/www/html;
    expires 1d; # Cache error page for 1 day
    add_header Cache-Control "public, max-age=86400";
    internal;
}
location = /50x.html {
    root /var/www/html;
    expires 1d; # Cache error page for 1 day
    add_header Cache-Control "public, max-age=86400";
    internal;
}

# Fallback for static assets not found
location @next {
    proxy_pass http://127.0.0.1:3003;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 90;
}